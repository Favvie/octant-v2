name: Weekly Yield Distribution

# Run every Monday at 9:00 AM UTC
on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  prepare-distribution:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd scripts
          npm install

      - name: Run weekly distribution preparation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WEEKLY_YIELD_AMOUNT: ${{ secrets.WEEKLY_YIELD_AMOUNT }}
          ASSET_ADDRESS: ${{ vars.ASSET_ADDRESS }}
          ASSET_SYMBOL: ${{ vars.ASSET_SYMBOL }}
          ASSET_DECIMALS: ${{ vars.ASSET_DECIMALS }}
          ALLOCATION_STRATEGY: ${{ vars.ALLOCATION_STRATEGY }}
        run: |
          cd scripts
          npm run weekly-distribution

      - name: Get week number
        id: week
        run: echo "number=$(date +%U)" >> $GITHUB_OUTPUT

      - name: Upload distribution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: week-${{ steps.week.outputs.number }}-distribution
          path: |
            data/distributions/epoch-${{ steps.week.outputs.number }}.json
            data/merkle-trees/epoch-${{ steps.week.outputs.number }}-*.json
            data/merkle-trees/epoch-${{ steps.week.outputs.number }}-*.txt
            data/merkle-trees/epoch-${{ steps.week.outputs.number }}-proofs/
            data/week-${{ steps.week.outputs.number }}-deployment.txt

      - name: Create Pull Request with distribution data
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'feat(distribution): week ${{ steps.week.outputs.number }} yield distribution data'
          branch: distribution/week-${{ steps.week.outputs.number }}
          title: 'Week ${{ steps.week.outputs.number }} Yield Distribution'
          body: |
            ## Week ${{ steps.week.outputs.number }} Yield Distribution

            This PR contains the prepared distribution data for this week's yield.

            ### Files Included:
            - Contributor allocations
            - Merkle tree and proofs
            - Deployment instructions

            ### Next Steps:
            1. Review the allocation in `data/distributions/epoch-${{ steps.week.outputs.number }}.json`
            2. Verify the Merkle root in `data/merkle-trees/epoch-${{ steps.week.outputs.number }}-root.txt`
            3. Follow deployment instructions in `data/week-${{ steps.week.outputs.number }}-deployment.txt`
            4. Create the epoch on-chain
            5. Share proof files with contributors

            ### Deployment Checklist:
            - [ ] Transfer yield to YieldDistributor
            - [ ] Create epoch on-chain
            - [ ] Notify contributors
            - [ ] Update frontend (if applicable)
          labels: |
            distribution
            automated

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Weekly distribution preparation failed',
              body: 'The automated weekly distribution workflow failed. Please check the logs and run manually if needed.',
              labels: ['distribution', 'bug']
            })
